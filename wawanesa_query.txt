WITH [_Target] ([_ResultID], [Party], [ProductGroup], [ProductGroup2], [ProductGroup3], [ProductGroup4], [ProductGroup5], [ProductGroup6], [ProductGroup7], [Attribute], [Months], [Value]) AS ( SELECT [_ResultID], [Party], [ProductGroup], [ProductGroup2], [ProductGroup3], [ProductGroup4], [ProductGroup5], [ProductGroup6], [ProductGroup7], [Attribute], [Months], [Value] FROM [_Result817] WHERE (((([_Result817].[Months]=N'2021, Month 01') OR ([_Result817].[Months]=N'2021, Month 02') OR ([_Result817].[Months]=N'2021, Month 03') OR ([_Result817].[Months]=N'2021, Month 04') OR ([_Result817].[Months]=N'2021, Month 05') OR ([_Result817].[Months]=N'2021, Month 06') OR ([_Result817].[Months]=N'2021, Month 07') OR ([_Result817].[Months]=N'2021, Month 08') OR ([_Result817].[Months]=N'2021, Month 09') OR ([_Result817].[Months]=N'2021, Month 10') OR ([_Result817].[Months]=N'2021, Month 11') OR ([_Result817].[Months]=N'2021, Month 12')))))MERGE [_Target] AS [_Result817] USING ( SELECT CAST(0 AS INT) [_ResultID], [_Result812].[_Column0] [Party], [_Result812].[_Column1] [ProductGroup], [_Result812].[_Column2] [ProductGroup2], [_Result812].[_Column3] [ProductGroup3], [_Result812].[_Column4] [ProductGroup4], [_Result812].[_Column5] [ProductGroup5], [_Result812].[_Column6] [ProductGroup6], [_Result812].[_Column7] [ProductGroup7], [_LookupAlias1].[_Column33] [Attribute], [_Time].[Name_] [Months], CASE WHEN dbo.[pmax]([pd]::[c]([_LookupAlias0].[_Column24])) IS NULL THEN NULL ELSE dbo.[pif](dbo.[psum]([pd]::[c]([_Result812].[_Column9])), '=', [pd]::[c](0.00000000000000),[pd]::[c](0.00000000000000),dbo.[div](dbo.[pmax]([pd]::[c]([_LookupAlias0].[_Column24])), dbo.[psum]([pd]::[c]([_Result812].[_Column9])))) END.ToDecimal() [Value] FROM ( SELECT [_Result812].[Party] [_Column0], [_Result812].[ProductGroup] [_Column1], [_Result812].[ProductGroup2] [_Column2], [_Result812].[ProductGroup3] [_Column3], [_Result812].[ProductGroup4] [_Column4], [_Result812].[ProductGroup5] [_Column5], [_Result812].[ProductGroup6] [_Column6], [_Result812].[ProductGroup7] [_Column7], [_Result812].[Months] [_Column8], [_Result812].[Value] [_Column9], [_Result812].[Attribute] [_Column10], [_TableAlias1].[Component] [_Column11], [_TableAlias1].[AccumulationType] [_Column12], [_TableAlias1].[NumericType] [_Column13], [_TableAlias1].[DataStream] [_Column14] FROM ( SELECT [_Result812].[Party], [_Result812].[ProductGroup], [_Result812].[ProductGroup2], [_Result812].[ProductGroup3], [_Result812].[ProductGroup4], [_Result812].[ProductGroup5], [_Result812].[ProductGroup6], [_Result812].[ProductGroup7], [_Result812].[Attribute], [_Result812].[Months], [_Result812].[Value] FROM ( SELECT * FROM [_Result812] [_Result812] WHERE (((([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 01')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 02')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 03')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 04')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 05')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 06')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 07')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 08')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 09')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 10')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 11')) OR (([_Result812].[Months] IS NOT NULL) AND ([_Result812].[Months]=N'2021, Month 12'))))) [_Result812] UNION ALL  SELECT [_Result812].[Party], [_Result812].[ProductGroup], [_Result812].[ProductGroup2], [_Result812].[ProductGroup3], [_Result812].[ProductGroup4], [_Result812].[ProductGroup5], [_Result812].[ProductGroup6], [_Result812].[ProductGroup7], [_Result812].[Attribute], [_Result812].[Months], [_Result812].[Value] FROM [_Result2063] [_Result812]) [_Result812] INNER JOIN [sysAttribute] [_TableAlias1] ON (([_TableAlias1].[Attribute]=[_Result812].[Attribute]))) [_Result812] INNER JOIN ( SELECT [_LookupAlias0].[Party] [_Column15], [_LookupAlias0].[ProductGroup] [_Column16], [_LookupAlias0].[ProductGroup2] [_Column17], [_LookupAlias0].[ProductGroup3] [_Column18], [_LookupAlias0].[ProductGroup4] [_Column19], [_LookupAlias0].[ProductGroup5] [_Column20], [_LookupAlias0].[ProductGroup6] [_Column21], [_LookupAlias0].[ProductGroup7] [_Column22], [_LookupAlias0].[Months] [_Column23], [_LookupAlias0].[Value] [_Column24], [_TableAlias0].[Component] [_Column25], [_TableAlias0].[AccumulationType] [_Column26], [_TableAlias0].[NumericType] [_Column27], [_TableAlias0].[DataStream] [_Column28] FROM [_Result812] [_LookupAlias0] INNER JOIN [sysAttribute] [_TableAlias0] ON (([_TableAlias0].[Attribute]=[_LookupAlias0].[Attribute]))) [_LookupAlias0] ON ((([_LookupAlias0].[_Column15]=[_Result812].[_Column0]) AND ([_LookupAlias0].[_Column16]=[_Result812].[_Column1]) AND ([_LookupAlias0].[_Column17]=[_Result812].[_Column2]) AND ([_LookupAlias0].[_Column18]=[_Result812].[_Column3]) AND ([_LookupAlias0].[_Column19]=[_Result812].[_Column4]) AND ([_LookupAlias0].[_Column20]=[_Result812].[_Column5]) AND ([_LookupAlias0].[_Column21]=[_Result812].[_Column6]) AND ([_LookupAlias0].[_Column22]=[_Result812].[_Column7]) AND ([_LookupAlias0].[_Column25]=N'INCURRED LOSS') AND ([_LookupAlias0].[_Column26]=[_Result812].[_Column12]) AND ([_LookupAlias0].[_Column27]=[_Result812].[_Column13]) AND ([_LookupAlias0].[_Column28]=[_Result812].[_Column14]) AND ([_LookupAlias0].[_Column23]=[_Result812].[_Column8]))) INNER JOIN ( SELECT [_LookupAlias1].[Component] [_Column29], [_LookupAlias1].[AccumulationType] [_Column30], [_LookupAlias1].[NumericType] [_Column31], [_LookupAlias1].[DataStream] [_Column32], [_LookupAlias1].[Attribute] [_Column33] FROM [sysAttribute] [_LookupAlias1]) [_LookupAlias1] ON ((([_LookupAlias1].[_Column29]=N'LOSS RATIO') AND ([_LookupAlias1].[_Column30]=[_Result812].[_Column12]) AND ([_LookupAlias1].[_Column31]=[_Result812].[_Column13]) AND ([_LookupAlias1].[_Column32]=[_Result812].[_Column14]))) INNER JOIN [_Period2] [_Time] ON (([_Time].[Name_]=[_Result812].[_Column8]) AND ([_Time].[Ending_]>=N'2021-01-01 00:00:00.000') AND ([_Time].[Ending_]<=N'2021-12-31 00:00:00.000')) WHERE (([_LookupAlias0].[_Column24] IS NOT NULL) AND ([_Result812].[_Column9] IS NOT NULL) AND (([_Result812].[_Column11]=N'EARNED PREMIUM') AND ([_Result812].[_Column12]=N'YTD')) AND ([_Result812].[_Column0] IS NOT NULL) AND ([_Result812].[_Column1] IS NOT NULL) AND ([_Result812].[_Column2] IS NOT NULL) AND ([_Result812].[_Column3] IS NOT NULL) AND ([_Result812].[_Column4] IS NOT NULL) AND ([_Result812].[_Column5] IS NOT NULL) AND ([_Result812].[_Column6] IS NOT NULL) AND ([_Result812].[_Column7] IS NOT NULL) AND ([_LookupAlias1].[_Column33] IS NOT NULL) AND (([_Result812].[_Column8]=N'2021, Month 01') OR ([_Result812].[_Column8]=N'2021, Month 02') OR ([_Result812].[_Column8]=N'2021, Month 03') OR ([_Result812].[_Column8]=N'2021, Month 04') OR ([_Result812].[_Column8]=N'2021, Month 05') OR ([_Result812].[_Column8]=N'2021, Month 06') OR ([_Result812].[_Column8]=N'2021, Month 07') OR ([_Result812].[_Column8]=N'2021, Month 08') OR ([_Result812].[_Column8]=N'2021, Month 09') OR ([_Result812].[_Column8]=N'2021, Month 10') OR ([_Result812].[_Column8]=N'2021, Month 11') OR ([_Result812].[_Column8]=N'2021, Month 12'))) GROUP BY [_Result812].[_Column0], [_Result812].[_Column1], [_Result812].[_Column2], [_Result812].[_Column3], [_Result812].[_Column4], [_Result812].[_Column5], [_Result812].[_Column6], [_Result812].[_Column7], [_LookupAlias1].[_Column33], [_Time].[Name_] HAVING ((CASE WHEN dbo.[pmax]([pd]::[c]([_LookupAlias0].[_Column24])) IS NULL THEN NULL ELSE dbo.[pif](dbo.[psum]([pd]::[c]([_Result812].[_Column9])), '=', [pd]::[c](0.00000000000000),[pd]::[c](0.00000000000000),dbo.[div](dbo.[pmax]([pd]::[c]([_LookupAlias0].[_Column24])), dbo.[psum]([pd]::[c]([_Result812].[_Column9])))) END IS NOT NULL))) AS [SOURCE] ON ([SOURCE].[Party] = [_Result817].[Party] AND [SOURCE].[ProductGroup] = [_Result817].[ProductGroup] AND [SOURCE].[ProductGroup2] = [_Result817].[ProductGroup2] AND [SOURCE].[ProductGroup3] = [_Result817].[ProductGroup3] AND [SOURCE].[ProductGroup4] = [_Result817].[ProductGroup4] AND [SOURCE].[ProductGroup5] = [_Result817].[ProductGroup5] AND [SOURCE].[ProductGroup6] = [_Result817].[ProductGroup6] AND [SOURCE].[ProductGroup7] = [_Result817].[ProductGroup7] AND [SOURCE].[Attribute] = [_Result817].[Attribute] AND [SOURCE].[Months] = [_Result817].[Months]) WHEN MATCHED AND EXISTS (Select [SOURCE].[Value] Except Select [_Result817].[Value]) AND ((([_Result817].[Months]=N'2021, Month 01') OR ([_Result817].[Months]=N'2021, Month 02') OR ([_Result817].[Months]=N'2021, Month 03') OR ([_Result817].[Months]=N'2021, Month 04') OR ([_Result817].[Months]=N'2021, Month 05') OR ([_Result817].[Months]=N'2021, Month 06') OR ([_Result817].[Months]=N'2021, Month 07') OR ([_Result817].[Months]=N'2021, Month 08') OR ([_Result817].[Months]=N'2021, Month 09') OR ([_Result817].[Months]=N'2021, Month 10') OR ([_Result817].[Months]=N'2021, Month 11') OR ([_Result817].[Months]=N'2021, Month 12'))) THEN UPDATE SET [Value] = [SOURCE].[Value] WHEN NOT MATCHED BY SOURCE AND ((([_Result817].[Months]=N'2021, Month 01') OR ([_Result817].[Months]=N'2021, Month 02') OR ([_Result817].[Months]=N'2021, Month 03') OR ([_Result817].[Months]=N'2021, Month 04') OR ([_Result817].[Months]=N'2021, Month 05') OR ([_Result817].[Months]=N'2021, Month 06') OR ([_Result817].[Months]=N'2021, Month 07') OR ([_Result817].[Months]=N'2021, Month 08') OR ([_Result817].[Months]=N'2021, Month 09') OR ([_Result817].[Months]=N'2021, Month 10') OR ([_Result817].[Months]=N'2021, Month 11') OR ([_Result817].[Months]=N'2021, Month 12'))) THEN DELETE WHEN NOT MATCHED BY TARGET THEN INSERT ([_ResultID], [Party], [ProductGroup], [ProductGroup2], [ProductGroup3], [ProductGroup4], [ProductGroup5], [ProductGroup6], [ProductGroup7], [Attribute], [Months], [Value]) VALUES (0, [SOURCE].[Party], [SOURCE].[ProductGroup], [SOURCE].[ProductGroup2], [SOURCE].[ProductGroup3], [SOURCE].[ProductGroup4], [SOURCE].[ProductGroup5], [SOURCE].[ProductGroup6], [SOURCE].[ProductGroup7], [SOURCE].[Attribute], [SOURCE].[Months], [SOURCE].[Value]);